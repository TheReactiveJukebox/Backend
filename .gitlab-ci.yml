stages:
- test
- build_backend
- build_image

variables:
  IMAGE_NAME_DEV: $CI_REGISTRY/jukebox/backend/dev:$CI_COMMIT_REF_SLUG
  IMAGE_NAME: $CI_REGISTRY/jukebox/backend/pro:$CI_COMMIT_REF_SLUG

test_backend:
  stage: test
  image: dockette/mvn
  script:
    - mvn --batch-mode --quiet --fail-at-end test
  artifacts:
    paths:
    - target/
    expire_in: 1 week

build_backend:
  stage: build_backend
  image: dockette/mvn
  script:
    - mvn --batch-mode --quiet --fail-at-end compiler:compile war:war
  artifacts:
    paths:
    - target/
    expire_in: 1 week

build_image_dev:
  stage: build_image
  only:
    - master
    - ft/gitlab_ci
    - ft/gitlab_ci_test
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build --pull -t $IMAGE_NAME_DEV -f Dockerfile.dev .
    - docker push $IMAGE_NAME

build_image:
  stage: build_image
  only:
    - master
    - ft/gitlab_ci
    - ft/gitlab_ci_test
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build --pull -t $IMAGE_NAME .
    - docker push $IMAGE_NAME
